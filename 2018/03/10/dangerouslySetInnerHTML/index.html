<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Rèven,pobusama@gmail.com"><title>再见吧👋 React dangerouslySetInnerHTML · REVEN'S BLOG</title><meta name="description" content="#
背景在 React 项目中常会遇到渲染 HTML 内容的情况。可以利用 react 的 dangerouslySetInnerHTML 属性，完成基础开发。
示例：
12345678function createMarkup() &amp;#123;  return &amp;#123;__html: 'Fir"><meta name="keywords" content="Hexo,HTML,CSS,Linux,Javascript"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">REVEN'S BLOG</a></h3><div class="description"><p>把思想炖在生活里，小点火侯</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/pobusama"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/pobusama"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="http://obhagvjtl.bkt.clouddn.com/person-icon2.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>再见吧👋 React dangerouslySetInnerHTML</a></h3></div><div class="post-content"><p>#</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在 React 项目中常会遇到渲染 HTML 内容的情况。可以利用 react 的 <a href="https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml" target="_blank" rel="noopener">dangerouslySetInnerHTML 属性</a>，完成基础开发。</p>
<p>示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMarkup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">__html</span>: <span class="string">'First &amp;middot; Second'</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">dangerouslySetInnerHTML</span>=<span class="string">&#123;createMarkup()&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><p>就作者目前查阅的资料和实践结果，上文提到的基础方案有一些不足。</p>
<h3 id="以非虚拟-DOM-的方式渲染节点"><a href="#以非虚拟-DOM-的方式渲染节点" class="headerlink" title="以非虚拟 DOM 的方式渲染节点"></a>以非虚拟 DOM 的方式渲染节点</h3><p>React 对虚拟 DOM 设计了优化的算法（主要依赖 <code>data-reactid</code>），放弃走虚拟 DOM 的渲染等同于放弃这些优化。</p>
<p>而 <code>dangerouslySetInnerHTML</code> 的渲染方式类似于原生 JS 的 HTML 渲染，显然放弃了节点优化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMarkup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">__html</span>: <span class="string">'&lt;div style="color: red"&gt;I m cool&lt;p&gt;&lt;/p&gt;&lt;/div&gt;'</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">dangerouslySetInnerHTML</span>=<span class="string">&#123;createMarkup()&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>实验下来，只有 <code>dangerouslySetInnerHTML</code> 所在的元素上带有 <code>data-reactid</code> ，而子元素都没有。</p>
<p><img src="https://n1image.hjfile.cn/res7/2018/03/10/09785b03086c112f85574485428ee312.jpeg" alt="示例图"></p>
<p>可以从 React 源码中证实：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReactDOMComponent.js 部分源码：</span></span><br><span class="line"><span class="comment">// 为方便阅读，只保留了 _createContentMarkup 函数的相关代码</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates markup for the content between the tags.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @private</span></span><br><span class="line"><span class="comment">   * @param &#123;ReactReconcileTransaction|ReactServerRenderingTransaction&#125; transaction</span></span><br><span class="line"><span class="comment">   * @param &#123;object&#125; props</span></span><br><span class="line"><span class="comment">   * @param &#123;object&#125; context</span></span><br><span class="line"><span class="comment">   * @return &#123;string&#125; Content markup.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _createContentMarkup: <span class="function"><span class="keyword">function</span> (<span class="params">transaction, props, context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> innerHTML = props.dangerouslySetInnerHTML; <span class="comment">// 拿到 dangerouslySetInnerHTML 内容</span></span><br><span class="line">    ret = innerHTML.__html;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为方便阅读，只保留了 ReactDOMComponent.Mixin.mountComponent 函数的相关代码</span></span><br><span class="line">ReactDOMComponent.Mixin = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Generates root tag markup then recurses. This method has side effects and</span></span><br><span class="line"><span class="comment">   * is not idempotent.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @internal</span></span><br><span class="line"><span class="comment">   * @param &#123;string&#125; rootID The root DOM ID for this node.</span></span><br><span class="line"><span class="comment">   * @param &#123;ReactReconcileTransaction|ReactServerRenderingTransaction&#125; transaction</span></span><br><span class="line"><span class="comment">   * @param &#123;object&#125; context</span></span><br><span class="line"><span class="comment">   * @return &#123;string&#125; The computed markup.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  mountComponent: <span class="function"><span class="keyword">function</span> (<span class="params">rootID, transaction, context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._rootNodeID = rootID;</span><br><span class="line">    <span class="keyword">var</span> props = <span class="keyword">this</span>._currentElement.props;</span><br><span class="line">    <span class="keyword">var</span> mountImage;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">var</span> tagOpen = <span class="keyword">this</span>._createOpenTagMarkupAndPutListeners(transaction, props);</span><br><span class="line">    <span class="comment">// 使用 _createContentMarkup</span></span><br><span class="line">    <span class="keyword">var</span> tagContent = <span class="keyword">this</span>._createContentMarkup(transaction, props, context);</span><br><span class="line">    <span class="comment">// 返回最终 dom 字符串只是把 _createContentMarkup 生成的 HTML 包裹一下</span></span><br><span class="line">    mountImage = tagOpen + <span class="string">'&gt;'</span> + tagContent + <span class="string">'&lt;/'</span> + <span class="keyword">this</span>._currentElement.type + <span class="string">'&gt;'</span>;</span><br><span class="line">    <span class="keyword">return</span> mountImage;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="XSS-攻击"><a href="#XSS-攻击" class="headerlink" title="XSS 攻击"></a>XSS 攻击</h3><p>关于 XSS 的话题有点大，作者仅以自己的实验说明：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMarkup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">__html</span>: <span class="string">`&lt;input type="btn" value="dont touch me" onclick="document.writeln('u idolt!')"&gt;`</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">dangerouslySetInnerHTML</span>=<span class="string">&#123;createMarkup()&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在基础方案下，input 元素完美渲染，点击正常，如果是恶意数据源，很容易造成严重后果。因此过滤必不可少。</p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><h3 id="1-弃用-dangerouslySetInnerHTML，把文本-HTML-内容转化为-React-DOM-对象。"><a href="#1-弃用-dangerouslySetInnerHTML，把文本-HTML-内容转化为-React-DOM-对象。" class="headerlink" title="1.弃用 dangerouslySetInnerHTML，把文本 HTML 内容转化为 React-DOM 对象。"></a>1.弃用 dangerouslySetInnerHTML，把文本 HTML 内容转化为 React-DOM 对象。</h3><p>从 <code>React</code> 0.x 过来的小伙伴应该还没忘记没有 JSX 的时代，手写 React DOM 对象的开发方式。就算到了如今 JSX 也是先转换成 React DOM 对象再进行后面的渲染。</p>
<p>把 HTML 翻译成对象数组目前已有成熟的方案，<a href="https://github.com/fb55/htmlparser2" target="_blank" rel="noopener">htmlparse2</a> 是个不错的选择。<br>不过 <code>htmlparse2</code> 生成的对象跟 React 特有的 DOM 对象还有一定距离，需要做进一步的转换，开源库 <code>react-html-parser</code> <a href="https://github.com/wrakky/react-html-parser/blob/master/src/utils/htmlAttributesToReact.js" target="_blank" rel="noopener">这里</a>做了不错的示范。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 react-html-parser 后：</span></span><br><span class="line"><span class="keyword">import</span> ReactHtmlParser <span class="keyword">from</span> <span class="string">'react-html-parser'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> html = <span class="string">`&lt;input type="btn" value="dont touch me" onclick="document.writeln('u idolt!')"&gt;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123; ReactHtmlParser(html) &#125;<span class="tag">&lt;<span class="name">div</span>/&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-过滤高危元素"><a href="#2-过滤高危元素" class="headerlink" title="2.过滤高危元素"></a>2.过滤高危元素</h3><p>防止 XSS 攻击的主要手段之一就是过滤危险标签，例如 <code>input</code> 这种类型的元素则是重点「嫌疑人」。基于上面提到的对象转化，做到过滤并不难。安全等级和体验的平衡，取决于我们对转化后的对象的细致过滤。比如发现 tag 类型是 input 时一棍子打死，比如把有 onclick 的元素全部干掉。对于 XSS，最安全的态度是「永远不要相信用户输入的数据」。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 react-html-parser 后：</span></span><br><span class="line"><span class="keyword">import</span> ReactHtmlParser <span class="keyword">from</span> <span class="string">'react-html-parser'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> html = <span class="string">`&lt;input type="btn" value="dont touch me" onclick="document.writeln('u idolt!')"&gt;`</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    &#123; ReactHtmlParser(html, &#123;</span></span><br><span class="line"><span class="xml">        transform: function transform (node) &#123;</span></span><br><span class="line"><span class="xml">            // 过滤 input 标签</span></span><br><span class="line"><span class="xml">            if (node.type === 'input') &#123;</span></span><br><span class="line"><span class="xml">                return null;</span></span><br><span class="line"><span class="xml">            &#125;</span></span><br><span class="line"><span class="xml">        &#125;</span></span><br><span class="line"><span class="xml">    &#125;) &#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span>/&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>已上是作者在实践过程中遇到的问题，问题恐怕不止于此，但仅两点足以让我放弃直接使用 <code>dangerouslySetInnerHTML</code>。这也正是 react 官方所提倡的做法，毕竟，这个属性的设计初衷就是要让开发者体会到「dangerous」。所以，再见吧，<code>dangerouslySetInnerHTML</code> ～</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-03-10</span><i class="fa fa-tag"></i><a class="tag" href="/categories/技术/" title="技术">技术 </a><a class="tag" href="/tags/React/" title="React">React </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2018/03/10/dangerouslySetInnerHTML/,REVEN'S BLOG,再见吧👋 React dangerouslySetInnerHTML,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/07/27/performance-dev-tool/" title="狙杀页面卡顿 —— Performance 指南">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/12/31/2017，进步/" title="2017，进步">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:true || false, 
  verify:true|| false, 
  app_id:'vPjtr6BKvaz821se9iFDov9m-gzGzoHsz',
  app_key:'nUoDbTcWFKDvvz7r5xPDVwON',
  placeholder:'Just go go',
  path: window.location.pathname,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>